var Grid=function(){"use strict";function t(t,e){return"string"==typeof t?(e||document).querySelector(t):t||null}function e(t,e){const i=document.createElement(t);for(let t in e)if("append_to"===t){e.append_to.appendChild(i)}else"innerHTML"===t?i.innerHTML=e.innerHTML:i.setAttribute(t,e[t]);return i}t.on=((e,i,s,n)=>{n?t.delegate(e,i,s,n):(n=s,t.bind(e,i,n))}),t.off=((t,e,i)=>{t.removeEventListener(e,i)}),t.bind=((t,e,i)=>{e.split(/\s+/).forEach(function(e){t.addEventListener(e,i)})}),t.delegate=((t,e,i,s)=>{t.addEventListener(e,function(t){const e=t.target.closest(i);e&&(t.delegatedTarget=e,s.call(this,t,e))})}),t.closest=((e,i)=>i?i.matches(e)?i:t.closest(e,i.parentNode):null),t.attr=((e,i,s)=>{if(!s&&0!==s&&"string"==typeof i)return e.getAttribute(i);if("object"!=typeof i)e.setAttribute(i,s);else for(let s in i)t.attr(e,s,i[s])}),t.styles=((e,i,s)=>{if(!s&&0!==s&&"string"==typeof style)return e.style[i];if("object"!=typeof i)"number"==typeof s&&(s+="px"),e.style[i]=s;else for(let s in i)t.styles(e,s,i[s])}),Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),Element.prototype.closest||(Element.prototype.closest=function(t){var e=this;if(!document.documentElement.contains(e))return null;do{if(e.matches(t))return e;e=e.parentElement||e.parentNode}while(null!==e&&1===e.nodeType);return null});class i{constructor(t,i){this.visibleNoFixed=i,this.columns=t,this.$element=e("tbody")}addRow(t){let i=e("tr");this.columns.forEach(e=>{this.addCell(i,e,t)}),this.$element.append(i)}addCell(i,s,n){let l=e("td"),r={};if(s.format&&"function"==typeof s.format?l.innerHTML=s.format(n[s.field]):l.innerHTML=n[s.field],s.attrs&&(r=Object.assign(r,s.attrs)),this.visibleNoFixed&&!s.fixed&&l.classList.add("william-hidden"),t.attr(l,r),s.rowSpan){let e=s.rowSpan(n,s),i="number"==typeof e;if(i&&e>1)t.attr(l,{rowspan:e});else if(i&&e<0)return}i.append(l)}renderData(t){t=t.data||[],this.$element.innerHTML="",t.forEach(this.addRow.bind(this))}render(t){t.append(this.$element)}}class s{constructor(t,i){this.visibleNoFixed=i,this.$element=e("thead"),this.addRow(t)}rowDepth(t,e){let i=[];for(let e of t)e.columns&&e.columns.length>0&&(i=i.concat(e.columns));return i.length>0?this.rowDepth(i,e+1):e}colDepth(t,e){let i=[],s=t.length;for(let e of t)e.columns&&e.columns.length>0&&(i=i.concat(e.columns));return i.length>0?this.colDepth(i,e+s-1):e+s}addRow(t){let i=e("tr"),s=[],n=this.rowDepth(t,1);t.forEach(t=>{this.addCell(i,t,n),t.columns&&(s=s.concat(t.columns))}),this.$element.append(i),s.length>0&&this.addRow(s)}addCell(i,s,n){let l=e("th"),r=0,o={};s.headFormat&&"function"==typeof s.headFormat?l.innerHTML=s.headFormat(s):l.innerHTML=s.title,s.headAttrs&&"object"==typeof s.headAttrs&&(o=Object.assign(o,s.headAttrs)),s.columns&&s.columns.length>0&&(o.colspan=this.colDepth(s.columns,0),r=this.rowDepth(s.columns,1)),this.visibleNoFixed&&!s.fixed&&l.classList.add("william-hidden"),(n-=r)>1&&(o.rowspan=n),t.attr(l,o),i.append(l)}render(t){t.append(this.$element)}}class n{constructor(){this._listener=[]}bind(t,e){let i=this._listener[t]||[];i.push(e),this._listener[t]=i}trigger(t){let e=Array.prototype.slice.apply(arguments).slice(1),i=this._listener[t];Array.isArray(i)&&i.forEach(function(t){try{t.apply(this,e)}catch(t){console.error(t)}})}}class l{constructor(i){this.$element=e("colgroup"),i.forEach(i=>{let s=e("col");i.hasOwnProperty("width")&&t.styles(s,{width:i.width}),this.$element.append(s)})}render(t){t.append(this.$element)}}class r{constructor(t){this.setupOptions(t),this.setupEmiiter(),this.initColgroup()}setupOptions(t){this.columns=t,this.unionColumns=this.concatColumn(t),this.colgroup=null,this.thead=null,this.tbody=null,this.$wrapper=e("div"),this.$element=e("table",{append_to:this.$wrapper,class:"william-table"})}setupEmiiter(){this.Emitter=new n}concatColumn(t){let e=Array.from(t),i=[];for(let t of e)t.columns?(t.columns.forEach(e=>{e.fixed=t.field}),i.push.apply(e,this.concatColumn(t.columns))):i.push(t);return i}getFixedColumns(){return this.unionColumns.filter(t=>t.fixed)}forColumnWidth(t,e){let i=0;for(let n of this.unionColumns)e(n)&&(i+=(s=n.width,s=parseInt(s),-1!=String(s).indexOf("%")?s/100*t:s));var s;return i}getColumnWidth(t){return Math.max(this.forColumnWidth(t,t=>t.width),t)}getFixedColumnWidth(t){return this.forColumnWidth(t,t=>t.width&&t.fixed)}getHeight(){return this.$element.offsetHeight}getWidth(){return this.$element.offsetWidth}setWidth(e){t.styles(this.$element,{width:e})}setHeight(e){t.styles(this.$element,{height:e})}setOuterWidth(e){t.styles(this.$wrapper,{width:e})}setOuterHeight(e){t.styles(this.$wrapper,{height:e})}setStyle(e){t.styles($element,e)}clone(){return new r(this.columns)}initColgroup(){this.colgroup=new l(this.unionColumns)}setHead(t){this.thead=t}initHead(t){this.thead=new s(this.columns,t)}initBody(t){this.tbody=new i(this.unionColumns,t)}renderData(t){this.tbody.renderData(t),this.Emitter.trigger("onRenderData",t)}render(t){this.colgroup.render(this.$element),this.thead&&this.thead.render(this.$element),this.tbody&&this.tbody.render(this.$element),t.append(this.$wrapper)}}return class{constructor(t,e){this.setupOptions(e),this.setupWrapper(t),this.initViewSize(),this.init()}setupOptions(t){this.options=Object.assign({},{columns:[],dataSource:null,autobind:!0,width:"auto",height:"auto"},t)}setupWrapper(t){if(t&&"string"==typeof t)this.$container=document.querySelector(t);else{if(!(t instanceof HTMLElement))throw new TypeError("请添加选择器！");this.$container=t}this.$container.classList.add("william-table-container"),this.$wrapper=e("div",{class:"william-table-wrapper",append_to:this.$container}),this.$fx_head=e("div",{class:"william-head",append_to:this.$wrapper}),this.$fx_body=e("div",{class:"william-body",append_to:this.$wrapper})}initViewSize(){function e(t,e){return"auto"!==t&&void 0!==t?parseInt(t):e}let i=this.$container.offsetWidth;this._width=e(this.options.width,0),this._height=e(this.options.height,0),this.isScroll=this._width>0||this._height>0,this.viewWidth=i,this._width>0&&t.styles(this.$container,{width:this._width})}init(){this.dataSource=this.options.dataSource,this.render(),this._successHandler(this.dataSource)}_successHandler(t){this.contentTable.renderData(t)}_failHandler(){}initTable(){this.contentTable=new r(this.options.columns),this.isFixedColumn=this.contentTable.getFixedColumns().length>0}initBody(){}_setHeadStyle(t){t.classList.add("william-head-table","william-hidden-scroll")}_setBodyStyle(t){t.classList.add("william-body-table","william-body-scroll")}_setFixedHeadStyle(t){t.classList.add("william-head-table","william-head-fixed","william-hidden-scroll")}_setFixedBodyStyle(t){t.classList.add("william-body-table","william-hidden-scroll","william-body-fixed")}initFixedTable(){let e,i,s=this._width,n=this._height,l=this.isFixedColumn,r=this.contentTable,o=this.contentTable.clone(),h=!1,a=!1,d=r.getColumnWidth(s),c=r.getFixedColumnWidth(s);function p(){s>0&&(o.setWidth(d),o.setOuterWidth(s),r.setWidth(d),r.setOuterWidth(s)),n>0&&s>0&&h?(o.setOuterWidth(s-17),r.setOuterHeight(n)):n>0&&h&&(t.styles(o.$wrapper,{marginRight:"17px"}),r.setOuterHeight(n)),l&&(i.setOuterWidth(c),i.setWidth(d),e.setOuterWidth(c),e.setWidth(d),t.styles(r.$wrapper,{width:s-c+"px",marginLeft:c+"px"}),t.styles(r.$element,{marginLeft:-c+"px"})),l&&n>0&&h&&e.setOuterHeight(n-17)}this._setHeadStyle(o.$wrapper),this._setBodyStyle(r.$wrapper),l&&((i=r.clone()).initHead(!0),(e=r.clone()).initBody(!0),i.render(this.$fx_head),e.render(this.$fx_body),this._setFixedHeadStyle(i.$wrapper),this._setFixedBodyStyle(e.$wrapper)),p(),r.initBody(),o.initHead(),o.render(this.$fx_head),r.render(this.$fx_body),r.Emitter.bind("onRenderData",function(t){l&&e.renderData(t),a=r.$wrapper.scrollWidth>s,h=r.$wrapper.scrollHeight>n,p()}),t.on(r.$wrapper,"scroll",function(){o&&(o.$wrapper.scrollLeft=this.scrollLeft),e&&(e.$wrapper.scrollTop=this.scrollTop)})}render(){let t=this;this.initTable(),this.isFixedColumn||this.isScroll?this.initFixedTable():(this.contentTable.initHead(),this.contentTable.initBody(),this.contentTable.render({append:function(e){t.$wrapper.append(e)}}))}}}();
